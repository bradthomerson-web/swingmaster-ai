<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwingMaster AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            flex: 1;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .header {
            background-color: #008060;
            color: white;
            padding: 30px 20px 20px 20px;
            text-align: center;
        }

        .logo { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .subtitle { font-size: 14px; opacity: 0.9; }

        .content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        .main-card {
            background: linear-gradient(135deg, #008060, #00a67d);
            color: white;
            padding: 30px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,128,96, 0.2);
            cursor: pointer;
            transition: all 0.3s ease; 
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .small-card {
            background-color: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            cursor: pointer;
            position: relative; 
        }
        .small-card:hover { border-color: #008060; }
        .icon { font-size: 28px; margin-bottom: 8px; display: block; }
        .label { font-weight: 600; color: #333; font-size: 14px; }

        /* LOCKED STATE STYLE */
        .locked-card { background-color: #f9f9f9; opacity: 0.8; }
        .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #d93025; 
            display: none; 
        }
        .locked-card .lock-icon { display: block; } 

        .nav-bar {
            background-color: white;
            padding: 15px 0;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            position: sticky;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        .nav-item { color: #999; font-size: 28px; cursor: pointer; padding: 10px; }
        .nav-item.active { color: #008060; }

        /* MODAL STYLES */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 85vh; 
            overflow-y: auto;
        }

        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 20px; font-weight: bold; }
        .close-x { cursor: pointer; color: #999; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; background: white; font-size: 16px; font-family: inherit; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 14px;}
        .save-btn { width: 100%; padding: 12px; background-color: #008060; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        
        .upgrade-btn { background: linear-gradient(135deg, #FFD700, #FFA500); color: black; font-weight: bold; margin-bottom: 10px;}
        .code-btn { background: #eee; color: #555; font-size: 12px; padding: 8px; margin-top: 10px; }

        /* EMERGENCY STYLES */
        .chat-box { background: #f0f0f0; border-radius: 8px; padding: 15px; margin-top: 15px; display: none; }
        .fix-title { color: #d93025; font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        .fix-body { font-size: 14px; color: #333; line-height: 1.4; }
        .drill-suggestion { margin-top: 10px; font-size: 12px; color: #008060; font-style: italic; border-top: 1px solid #ddd; padding-top: 5px; }

        /* PLAN LIST STYLES (ACCORDION) */
        .plan-list { list-style: none; padding: 0; }
        .plan-item { background: #f0fdf9; border-left: 5px solid #008060; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .plan-item:hover { background: #e0fcf5; }
        .drill-header { display: flex; justify-content: space-between; align-items: center; }
        .drill-name { font-weight: bold; color: #333; }
        .drill-time { font-size: 12px; color: #008060; font-weight: bold; margin-right: 10px; }
        .drill-tag { font-size: 10px; background: #ddd; padding: 2px 6px; border-radius: 4px; color: #555; }
        .drill-instruction { display: none; margin-top: 10px; font-size: 14px; color: #555; border-top: 1px solid #d4ece5; padding-top: 10px; line-height: 1.4; }

        /* LOADING */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #008060; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #planContent { display: none; }

    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <div class="logo">SwingMasterAI</div>
            <div class="subtitle">Your Personalized Coach</div>
            <div id="proBadge" style="display:none; background:#FFD700; color:black; font-size:10px; padding:2px 6px; border-radius:4px; margin-top:5px;">PRO MEMBER</div>
        </div>

        <div class="content">
            <div class="main-card" onclick="checkPlanLimit()">
                <h2 id="plan-title">Generate Today's Plan</h2>
                <p id="plan-desc">1 Free AI Lesson Remaining</p>
            </div>

            <div class="grid-container">
                <div class="small-card" onclick="openProfile()">
                    <span class="icon">üë§</span><span class="label">Profile</span>
                </div>
                <div class="small-card" onclick="openInputForm()">
                    <span class="icon">‚õ≥</span><span class="label">Input Round</span>
                </div>
                
                <div id="emergencyCard" class="small-card locked-card" onclick="openEmergency()">
                    <span class="lock-icon">üîí</span>
                    <span class="icon">üöë</span><span class="label">Fix My Shot</span>
                </div>

                <div class="small-card" onclick="openGPS()">
                    <span class="icon">üì°</span><span class="label">GPS</span>
                </div>
                <div class="small-card" onclick="openTrends()">
                    <span class="icon">üìà</span><span class="label">Trends</span>
                </div>
                <div class="small-card" onclick="alert('Settings')">
                    <span class="icon">‚öôÔ∏è</span><span class="label">Settings</span>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üìä</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <div id="paywallModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size:40px;">üîí</div>
            <h2 style="margin-top:10px;">Upgrade to PRO</h2>
            <p style="color:#555; margin-bottom:20px;">Unlock unlimited plans & the Emergency Caddie.</p>
            <button class="save-btn upgrade-btn" onclick="goToStripe()">Pay $49 Annually</button>
            <p style="font-size:12px; color:#999; margin:10px;">Already paid?</p>
            <button class="save-btn code-btn" onclick="enterCode()">Enter Access Code</button>
            <p style="font-size:12px; color:#999; margin-top:15px; cursor:pointer;" onclick="closePaywall()">No thanks</p>
        </div>
    </div>

    <div id="emergencyModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>Fix My Shot</span><span class="close-x" onclick="closeEmergency()">X</span></div>
            <p style="font-size:14px; color:#555;">Describe your miss (e.g., "Hitting it fat")</p>
            <textarea id="issueInput" rows="3" placeholder="Type here..."></textarea>
            <button class="save-btn" onclick="analyzeShot()">Get Quick Fix</button>
            <div id="aiFixDisplay" class="chat-box">
                <div class="fix-title">‚ö° Quick Fix</div>
                <div class="fix-body" id="fixText"></div>
                <div class="drill-suggestion" id="drillText"></div>
            </div>
        </div>
    </div>

    <div id="planModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="routineTitle">Thinking...</span><span class="close-x" onclick="closePlan()">X</span></div>
            <div class="loader" id="planLoader"></div>
            <div id="planContent">
                <p id="planIntro" style="font-size:12px; color:#555; margin-bottom:10px; font-style:italic;"></p>
                <p style="font-size:11px; color:#999;">(Tap drill to see instructions)</p>
                <ul class="plan-list" id="routineList"></ul>
                <button class="save-btn" onclick="closePlan()">Done</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>Profile</span><span class="close-x" onclick="closeProfile()">X</span></div><label>Age</label><input type="number" id="pAge" placeholder="35"><label>Handicap</label><input type="number" id="pHandicap" placeholder="15"><label>Equipment</label><input type="text" id="pEquipment"><label>Weakness</label><select id="pWeakness"><option value="auto">Auto-Detect</option><option value="driving">Driving</option><option value="irons">Irons</option><option value="bunkers">Bunkers</option><option value="putting">Putting</option></select><button class="save-btn" onclick="saveProfile()">Save</button></div></div>
    <div id="roundModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>Log Round</span><span class="close-x" onclick="closeInputForm()">X</span></div><label>Score</label><input type="number" id="inScore"><label>Putts</label><input type="number" id="inPutts"><label>Fairways</label><input type="number" id="inFairways"><button class="save-btn" onclick="saveData()">Save</button></div></div>
    <div id="gpsModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>GPS</span><span class="close-x" onclick="closeGPS()">X</span></div><h1 style="text-align:center; font-size:60px;">150</h1><p style="text-align:center;">Center of Green</p></div></div>
    <div id="trendsModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>Stats</span><span class="close-x" onclick="closeTrends()">X</span></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; text-align:center;"><div><div style="font-weight:bold; color:#008060; font-size:18px;" id="avgScore">--</div><div style="font-size:12px;">Score</div></div><div><div style="font-weight:bold; color:#008060; font-size:18px;" id="avgPutts">--</div><div style="font-size:12px;">Putts</div></div><div><div style="font-weight:bold; color:#008060; font-size:18px;" id="avgFairways">--</div><div style="font-size:12px;">Fairway</div></div></div><hr style="border:0; border-top:1px solid #eee; margin:15px 0;"><ul id="scoreList" class="plan-list"></ul><button class="delete-btn" onclick="clearAllData()" style="color:red; background:none; border:none; width:100%; margin-top:15px; cursor:pointer;">Reset</button></div></div>

    <script>
        // --- YOUR STRIPE LINK ---
        const STRIPE_LINK = "https://buy.stripe.com/14AbJ1dH699J2yIaQ24AU00"; 
        
        let isPro = false; 
        let roundHistory = [];
        let userProfile = { age: "", handicap: "", equipment: "", weakness: "auto" };
        let todayStr = new Date().toDateString();

        // --- ON LOAD (Includes ?pro=1 Check) ---
        window.onload = function() {
            
            // 1. CHECK URL FOR PAYMENT SUCCESS
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('pro') === '1') {
                activateProMode();
                alert("Payment Successful! Pro Features Unlocked.");
                // Optional: Clean URL so a refresh doesn't re-trigger (visual only)
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // 2. CHECK MEMORY
            let savedPro = localStorage.getItem('isProMember');
            if (savedPro === "true") {
                activateProMode();
            }

            // 3. LOAD DATA
            let savedData = localStorage.getItem('swingMasterData');
            if (savedData) roundHistory = JSON.parse(savedData);
            let savedProfile = localStorage.getItem('swingMasterProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                document.getElementById('pAge').value = userProfile.age;
                document.getElementById('pHandicap').value = userProfile.handicap;
                document.getElementById('pWeakness').value = userProfile.weakness;
                document.getElementById('pEquipment').value = userProfile.equipment;
            }
            if (!isPro && localStorage.getItem('lastPlanDate') === todayStr) {
                 document.getElementById('plan-desc').innerText = "Free Limit Reached";
            }
        };

        // --- PRO LOGIC ---
        function activateProMode() {
            isPro = true;
            localStorage.setItem('isProMember', "true"); // Save to memory
            document.getElementById('proBadge').style.display = "inline-block";
            document.getElementById('plan-desc').innerText = "Unlimited AI Access";
            
            let card = document.getElementById('emergencyCard');
            card.classList.remove('locked-card');
            card.querySelector('.lock-icon').style.display = 'none'; 
        }

        function openPaywall() { document.getElementById('paywallModal').style.display = 'flex'; }
        function closePaywall() { document.getElementById('paywallModal').style.display = 'none'; }
        
        function goToStripe() {
            window.open(STRIPE_LINK, '_blank');
        }

        function enterCode() {
            let code = prompt("Enter access code (Test with: SWING49)");
            if (code === "SWING49") {
                activateProMode();
                closePaywall();
                alert("Code Accepted!");
            } else {
                alert("Invalid Code");
            }
        }

        // --- BUSINESS RULES ---
        function checkPlanLimit() {
            if (isPro) { generateLogic(); return; }
            let lastUsed = localStorage.getItem('lastPlanDate');
            if (lastUsed === todayStr) { openPaywall(); } else { localStorage.setItem('lastPlanDate', todayStr); generateLogic(); }
        }

        function openEmergency() { 
            if(!isPro) openPaywall(); 
            else { document.getElementById('emergencyModal').style.display = 'flex'; document.getElementById('issueInput').value=""; document.getElementById('aiFixDisplay').style.display='none'; }
        }
        function closeEmergency() { document.getElementById('emergencyModal').style.display = 'none'; }

        function analyzeShot() {
            let text = document.getElementById('issueInput').value.toLowerCase();
            if(text.length<3) return;
            let ans="Breathe and reset."; let drill="Tempo Drill";
            if(text.includes("fat")) { ans="Ball too far forward or hanging back. Move ball back 1 inch."; drill="Step-Through Drill"; }
            else if(text.includes("slice")) { ans="Face open. Strengthen grip."; drill="Headcover Drill"; }
            else if(text.includes("hook")) { ans="Path too inside. Weaken grip."; drill="Alignment Stick Block"; }
            else if(text.includes("shank")) { ans="Too close to ball. Step back 1 inch. Weight on heels."; drill="2-Ball Drill"; }
            document.getElementById('fixText').innerText = ans; 
            document.getElementById('drillText').innerText = drill;
            document.getElementById('aiFixDisplay').style.display = 'block';
        }

        // --- PLAN GENERATOR & ACCORDION ---
        function generateLogic() {
            document.getElementById('planModal').style.display = 'flex';
            document.getElementById('planLoader').style.display = 'block';
            document.getElementById('planContent').style.display = 'none';
            document.getElementById('routineTitle').innerText = "Analyzing Stats...";

            setTimeout(() => {
                document.getElementById('planLoader').style.display = 'none';
                document.getElementById('planContent').style.display = 'block';

                let age = parseInt(userProfile.age) || 30; 
                let equipText = (userProfile.equipment || "").toLowerCase();
                let isSenior = (age >= 60);
                let hasNet = equipText.includes("net");
                let isIndoor = equipText.includes("mat") || equipText.includes("indoor");

                let focusArea = "irons"; 
                if (userProfile.weakness !== "auto") { focusArea = userProfile.weakness; } 
                else if (roundHistory.length > 0) {
                    let totalP = 0, totalF = 0;
                    for(let i=0; i<roundHistory.length; i++) { totalP += roundHistory[i].putts; totalF += roundHistory[i].fairways; }
                    let avgP = totalP / roundHistory.length; let avgF = totalF / roundHistory.length;
                    if (avgP > 34) focusArea = "putting"; else if (avgF < 7) focusArea = "driving";
                }

                let intro = "AI Analysis: ";
                if (hasNet) intro += "Net Mode. ";
                if (isSenior) intro += "Tempo Focus. ";
                document.getElementById('planIntro').innerText = intro;
                document.getElementById('routineTitle').innerText = "Focus: " + focusArea.toUpperCase();

                let html = "";
                if (focusArea === "driving") {
                    if (isSenior) html += createDrill("10m", "Whoosh Drill", "Tempo", "Flip driver upside down. Swing holding shaft. Make the 'whoosh' sound happen at impact.");
                    else html += createDrill("10m", "Driver Stretch", "Mobility", "Hold club across chest. Rotate 90 degrees. Hold for 3 seconds.");
                    if (hasNet) html += createDrill("10m", "Impact Tape", "Contact", "Spray face. Hit 5 balls. Check contact point.");
                    else html += createDrill("10m", "Fairway Finder", "Accuracy", "Pick a narrow target. Score 1 point for hit, -1 for miss.");
                } 
                else if (focusArea === "putting") {
                    if (isIndoor) {
                        html += createDrill("10m", "Gate Drill", "Path", "Put two tees just wider than putter head. Swing through without hitting them.");
                        html += createDrill("10m", "Ruler Drill", "Start Line", "Roll ball down a yardstick without it falling off.");
                    } else {
                        html += createDrill("10m", "Circle Drill", "Pressure", "Make 6 putts in a row from 3 feet. Restart if you miss.");
                        html += createDrill("10m", "Lag Drill", "Speed", "Putt 3 balls to fringe. Try to stop them within 1 foot.");
                    }
                } 
                else { 
                    html += createDrill("10m", "Divot Check", "Contact", "Divot must start AFTER the ball.");
                    html += createDrill("10m", "9-Ball Flight", "Control", "Hit 3 high, 3 low, 3 stock.");
                }

                document.getElementById('routineList').innerHTML = html;
            }, 1000);
        }

        function createDrill(time, name, tag, inst) {
            return `<li class="plan-item" onclick="toggleDrill(this)">
                <div class="drill-header"><div><span class="drill-time">${time}</span><span class="drill-name">${name}</span></div><span class="drill-tag">${tag}</span></div>
                <div class="drill-instruction">${inst}</div>
            </li>`;
        }
        function toggleDrill(el) {
            let d = el.querySelector('.drill-instruction');
            d.style.display = (d.style.display==='block') ? 'none' : 'block';
        }

        function closePlan() { document.getElementById('planModal').style.display = 'none'; }
        
        // STANDARD HELPERS
        function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }
        function closeProfile() { document.getElementById('profileModal').style.display = 'none'; }
        function saveProfile() {
            userProfile.age = document.getElementById('pAge').value;
            userProfile.handicap = document.getElementById('pHandicap').value;
            userProfile.weakness = document.getElementById('pWeakness').value;
            userProfile.equipment = document.getElementById('pEquipment').value;
            localStorage.setItem('swingMasterProfile', JSON.stringify(userProfile));
            closeProfile();
            alert("Saved!");
        }
        function openInputForm() { document.getElementById('roundModal').style.display = 'flex'; }
        function closeInputForm() { document.getElementById('roundModal').style.display = 'none'; }
        function saveData() {
            let s = document.getElementById('inScore').value;
            let p = document.getElementById('inPutts').value || 30;
            let f = document.getElementById('inFairways').value || 5;
            if(s) { roundHistory.push({score:parseInt(s), putts:parseInt(p), fairways:parseInt(f)}); localStorage.setItem('swingMasterData', JSON.stringify(roundHistory)); closeInputForm(); alert("Saved!"); }
        }
        function openGPS() { document.getElementById('gpsModal').style.display = 'flex'; }
        function closeGPS() { document.getElementById('gpsModal').style.display = 'none'; }
        function openTrends() { 
            if(roundHistory.length>0) {
                let s=0, p=0, f=0;
                for(let i=0; i<roundHistory.length; i++) { s+=roundHistory[i].score; p+=roundHistory[i].putts; f+=roundHistory[i].fairways; }
                let c = roundHistory.length;
                document.getElementById('avgScore').innerText = (s/c).toFixed(1);
                document.getElementById('avgPutts').innerText = (p/c).toFixed(1);
                document.getElementById('avgFairways').innerText = (f/c).toFixed(1);
                let html = "";
                for(let i=roundHistory.length-1; i>=0; i--) html += `<li class="plan-item" style="cursor:default;">Round ${i+1}: ${roundHistory[i].score}</li>`;
                document.getElementById('scoreList').innerHTML = html;
            }
            document.getElementById('trendsModal').style.display = 'flex'; 
        }
        function closeTrends() { document.getElementById('trendsModal').style.display = 'none'; }
        function clearAllData() { localStorage.removeItem('swingMasterData'); roundHistory=[]; closeTrends(); }
    </script>
</body>
</html>